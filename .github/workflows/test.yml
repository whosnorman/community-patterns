name: Pattern Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
env:
  CT_COMMIT_SHA: 192230e7ec21ab6832362e7cce13bdedc959de84

jobs:
  check-patterns:
    name: "Check Patterns"
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          path: repo

      - name: ðŸ“¥ Download tarball from GCS
        run: |
          mkdir -p downloaded-artifacts/
          curl -sL https://storage.googleapis.com/commontools-build-artifacts/workspace-artifacts/labs-${{ env.CT_COMMIT_SHA }}.tar.gz -o downloaded-artifacts/labs-${{ env.CT_COMMIT_SHA }}.tar.gz 

          # Verify the tarball exists
          if [ ! -f downloaded-artifacts/labs-${{ env.CT_COMMIT_SHA }}.tar.gz ]; then
            echo "::error::Artifact tarball for commit ${{ env.CT_COMMIT_SHA }} not found!"
            echo "Make sure this commit was successfully built and artifacts were uploaded."
            exit 1
          fi

      - name: ðŸ“¥ Install ct
        run: |
          mkdir -p bin
          # Extract the jumble frontend artifacts from the tarball if they exist
          # or download them from a known location if stored separately
          tar -xzf downloaded-artifacts/labs-${{ env.CT_COMMIT_SHA }}.tar.gz -C bin
          chmod -R 755 bin
          # Set tools to path
          echo "${{ github.workspace }}/bin" >> $GITHUB_PATH

      - name: ðŸ‘† Initialize ct environment
        working-directory: repo
        run: ct init

      - name: ðŸ”¡ Type Check
        working-directory: repo
        run: ./scripts/typecheck.sh -f '!WIP'
   
      - name: ðŸ”¡ Type Check (WIP, Fallible)
        continue-on-error: true # Don't fail the workflow if tests fail
        working-directory: repo
        run: ./scripts/typecheck.sh -f 'WIP'
